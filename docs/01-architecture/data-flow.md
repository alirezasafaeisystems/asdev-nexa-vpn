# Data Flow (جریان داده‌ها)

---

## 🔄 جریان اصلی: خرید اشتراک

```
┌──────────────────────────────────────────────────────────────────┐
│                    Flow A: Purchase Subscription                  │
├──────────────────────────────────────────────────────────────────┤
│                                                                   │
│  1. User                                                         │
│     └──▶ انتخاب پلن                                              │
│          └──▶ POST /api/v1/invoices {planId}                     │
│                                                                   │
│  2. Server                                                       │
│     └──▶ ایجاد Invoice (PENDING)                                 │
│          └──▶ ارسال آدرس کیف پول                                 │
│                                                                   │
│  3. User                                                         │
│     └──▶ ارسال USDT به آدرس                                      │
│                                                                   │
│  4. Worker (payment_watch)                                       │
│     └──▶ تشخیص تراکنش                                            │
│          └──▶ بروزرسانی Payment (SETTLED)                        │
│               └──▶ enqueue provision job                         │
│                                                                   │
│  5. Worker (provision)                                           │
│     └──▶ ایجاد Subscription                                      │
│          └──▶ فراخوانی Hiddify API                               │
│               └──▶ ایجاد UserConfig                              │
│                    └──▶ ارسال نوتیف به کاربر                     │
│                                                                   │
└──────────────────────────────────────────────────────────────────┘
```

---

## 🔄 جریان: دریافت کانفیگ

```
┌──────────────────────────────────────────────────────────────────┐
│                    Flow B: Get VPN Config                         │
├──────────────────────────────────────────────────────────────────┤
│                                                                   │
│  1. User                                                         │
│     └──▶ GET /api/v1/configs                                     │
│                                                                   │
│  2. Server                                                       │
│     └──▶ بررسی احراز هویت                                        │
│          └──▶ دریافت UserConfig[] از دیتابیس                     │
│               └──▶ بازگشت configUrl برای هر کانفیگ               │
│                                                                   │
│  3. User                                                         │
│     └──▶ کپی لینک یا اسکن QR Code                                │
│          └──▶ وارد کردن در اپلیکیشن (Hiddify/V2Ray)              │
│                                                                   │
└──────────────────────────────────────────────────────────────────┘
```

---

## 🔄 جریان: پشتیبانی تلگرام

```
┌──────────────────────────────────────────────────────────────────┐
│                    Flow C: Telegram Support                       │
├──────────────────────────────────────────────────────────────────┤
│                                                                   │
│  1. User                                                         │
│     └──▶ ایجاد تیکت در وب                                        │
│          └──▶ POST /api/v1/tickets                               │
│                                                                   │
│  2. Server                                                       │
│     └──▶ ذخیره Ticket در دیتابیس                                 │
│          └──▶ enqueue notify job                                 │
│                                                                   │
│  3. Worker (notify)                                              │
│     └──▶ ارسال پیام به تلگرام                                    │
│          └──▶ شامل: TicketID, موضوع, پیام                        │
│                                                                   │
│  4. Support (Telegram)                                           │
│     └──▶ پاسخ به پیام                                            │
│          └──▶ ارسال به @nexavpn_support                          │
│                                                                   │
│  5. Telegram Webhook                                             │
│     └──▶ POST /api/v1/telegram/webhook                           │
│          └──▶ استخراج TicketID                                   │
│               └──▶ ذخیره TicketMessage                           │
│                    └──▶ اطلاع به کاربر                           │
│                                                                   │
└──────────────────────────────────────────────────────────────────┘
```

---

## 🔄 جریان: Trial رایگان

```
┌──────────────────────────────────────────────────────────────────┐
│                    Flow D: Free Trial                             │
├──────────────────────────────────────────────────────────────────┤
│                                                                   │
│  1. User (جدید)                                                  │
│     └──▶ ثبت‌نام                                                  │
│          └──▶ hasUsedTrial = false                               │
│                                                                   │
│  2. User                                                         │
│     └──▶ درخواست Trial                                           │
│          └──▶ POST /api/v1/trial                                 │
│                                                                   │
│  3. Server                                                       │
│     └──▶ بررسی hasUsedTrial                                      │
│          └──▶ ایجاد Subscription (3 روز, 5 گیگ)                  │
│               └──▶ set hasUsedTrial = true                       │
│                    └──▶ فراخوانی Hiddify                         │
│                         └──▶ ایجاد UserConfig                    │
│                                                                   │
└──────────────────────────────────────────────────────────────────┘
```

---

## 📊 State Machines

### Invoice State
```
CREATED ──▶ PENDING ──▶ PAID
    │          │
    │          ├──▶ EXPIRED
    │          │
    │          └──▶ REFUNDED
    │
    └──▶ CANCELED
```

### Subscription State
```
ACTIVE ──▶ EXPIRED
    │
    ├──▶ CANCELED
    │
    └──▶ SUSPENDED
```

### Payment State
```
CREATED ──▶ PENDING ──▶ DETECTED ──▶ CONFIRMED ──▶ SETTLED
    │          │            │            │
    │          │            └──▶ FAILED  │
    │          │                         │
    │          └──▶ EXPIRED              │
    │                                    │
    └────────────────────────────────────┘
```
